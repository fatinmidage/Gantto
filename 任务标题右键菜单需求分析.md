# 任务标题右键菜单功能需求分析

## 项目背景
Gantto 甘特图应用需要为任务标题列添加独立的右键菜单功能，用于快速编辑任务名称和图标，提升用户操作体验。

## 需求概述

### 功能目标
为任务标题列创建独立的右键菜单，专门用于任务标题相关的编辑操作，与甘特图区域的任务右键菜单相互独立。

### 核心功能
1. **独立右键菜单**：在任务标题文本区域右键显示专用菜单
2. **任务名称编辑**：支持内联编辑任务名称
3. **任务图标选择**：通过二级菜单选择任务图标

## 详细需求规格

### 1. 菜单触发
- **触发位置**：`TaskTitleItem.tsx` 组件的任务标题文本区域
- **触发方式**：鼠标右键点击
- **适用范围**：所有任务标题（包括占位任务）
- **权限控制**：无特殊限制，所有任务都可编辑

### 2. 菜单结构
```
TaskTitleContextMenu
├── 更改任务名称
└── 更改任务图标 > [图标选择器二级菜单]
                   ├── 默认图标
                   ├── 开发图标
                   ├── 测试图标
                   ├── 交付图标
                   └── 里程碑图标
```

### 3. 功能详细设计

#### 3.1 更改任务名称
- **触发方式**：点击"更改任务名称"菜单项
- **编辑模式**：内联编辑（在原位置直接编辑）
- **交互逻辑**：
  - 点击菜单项后立即进入编辑模式
  - 菜单自动关闭
  - 任务标题文本变为可编辑输入框
  - 自动选中当前文本内容
- **确认操作**：
  - 按 Enter 键确认修改
  - 点击其他地方确认修改
  - 按 Escape 键取消修改
- **数据更新**：直接更新任务数据，无需额外确认
- **视觉样式**：简洁的内联编辑样式，无需特殊视觉效果

#### 3.2 更改任务图标
- **触发方式**：鼠标悬停"更改任务图标"菜单项
- **显示方式**：二级菜单形式，在主菜单右侧展开
- **图标选项**：
  - 默认图标 (default)
  - 开发图标 (development)
  - 测试图标 (testing)
  - 交付图标 (delivery)
  - 里程碑图标 (milestone)
- **选择逻辑**：
  - 点击图标选项立即应用
  - 菜单自动关闭
  - 任务图标实时更新
- **数据更新**：直接更新任务的 type 字段

### 4. 菜单独立性
- **完全独立**：与现有的 `TaskContextMenu.tsx`（甘特图区域右键菜单）完全分离
- **功能互补**：
  - 任务标题菜单：专注于标题编辑（名称+图标）
  - 甘特图任务菜单：专注于任务属性（颜色+标签+删除）

## 技术实现要点

### 1. 组件架构
```
TaskTitleItem.tsx
├── 集成右键事件处理
└── 渲染 TaskTitleContextMenu.tsx
    ├── 菜单项：更改任务名称
    └── 菜单项：更改任务图标
        └── 二级菜单：图标选择器
```

### 2. 关键组件
- **TaskTitleContextMenu.tsx**：新建的独立右键菜单组件
- **TaskTitleItem.tsx**：集成右键菜单功能
- **TaskIconSelector.tsx**：复用现有图标选择器（如果存在）

### 3. 状态管理
- 菜单显示/隐藏状态
- 当前编辑的任务 ID
- 内联编辑状态
- 二级菜单展开状态

### 4. 事件处理
- 右键菜单事件
- 内联编辑事件（Enter/Escape/点击外部）
- 图标选择事件
- 菜单关闭事件

## 用户体验设计

### 交互流程
1. **右键触发**：用户在任务标题文本上右键点击
2. **菜单显示**：显示包含两个选项的右键菜单
3. **选择操作**：
   - 选择"更改任务名称" → 进入内联编辑
   - 悬停"更改任务图标" → 展开图标选择二级菜单
4. **完成操作**：修改立即生效，菜单自动关闭

### 视觉设计
- **菜单样式**：与现有右键菜单保持一致的视觉风格
- **二级菜单**：平滑的展开动画，清晰的图标展示
- **内联编辑**：简洁的输入框样式，保持与任务标题的视觉连贯性

## 实现优先级

### 高优先级
1. 创建 TaskTitleContextMenu 基础组件
2. 集成右键菜单到 TaskTitleItem
3. 实现任务名称内联编辑功能

### 中优先级
4. 实现图标选择器二级菜单
5. 完善交互细节和用户体验
6. 测试功能完整性

## 验收标准

### 功能验收
- [x] 右键点击任务标题可以触发独立菜单
- [x] 菜单包含"更改任务名称"和"更改任务图标"两个选项
- [x] 内联编辑功能正常：Enter确认、Escape取消、点击外部确认
- [x] 图标选择器以二级菜单形式正常展示和工作
- [x] 修改操作立即生效并更新界面
- [x] 与甘特图区域右键菜单完全独立，互不影响

### 体验验收
- [x] 菜单显示位置合理，不超出屏幕边界
- [x] 二级菜单展开流畅，视觉效果良好
- [x] 内联编辑状态清晰，操作直观
- [x] 所有交互响应及时，无明显延迟

## 🎉 实现完成状态

### ✅ 已实现功能（2025-07-20）

**1. 核心组件**
- ✅ `TaskTitleContextMenu.tsx` - 独立右键菜单组件
- ✅ `TaskTitleItem.tsx` - 集成右键菜单和内联编辑功能
- ✅ 数据流集成 - 通过 `handleTaskUpdate` 函数更新任务数据

**2. 功能特性**
- ✅ 右键菜单触发和显示
- ✅ 任务名称内联编辑（Enter/Escape/点击外部）
- ✅ 图标选择器二级菜单（悬停展开）
- ✅ 实时数据更新和界面刷新
- ✅ 与甘特图区域菜单完全独立

**3. 技术实现**
- ✅ 组件状态管理（菜单显示、编辑模式、二级菜单）
- ✅ 事件处理（右键、键盘、鼠标悬停）
- ✅ 数据流设计（StateManager → EventCoordinator → Container → TitleColumn → TitleItem）
- ✅ TypeScript 类型安全
- ✅ 项目编译通过，开发服务器正常启动

### 📁 涉及的文件

**新增文件：**
- `src/components/gantt/TaskTitleContextMenu.tsx` - 右键菜单组件

**修改文件：**
- `src/components/gantt/components/TaskTitleItem.tsx` - 集成右键菜单和内联编辑
- `src/components/gantt/TaskTitleColumn.tsx` - 添加 onTaskUpdate props
- `src/components/gantt/GanttChartBody.tsx` - 传递任务更新函数
- `src/components/gantt/GanttContainer.tsx` - 数据流传递
- `src/components/gantt/GanttEventCoordinator.tsx` - 事件协调
- `src/components/gantt/GanttStateManager.tsx` - 状态管理和数据更新
- `src/components/GanttChart.tsx` - 顶层数据流集成

### 🔍 调试指南

**常见问题排查：**

1. **右键菜单不显示**
   - 检查 `handleContextMenu` 事件是否正确绑定
   - 确认 `contextMenu.visible` 状态更新
   - 验证菜单位置计算 (`e.clientX`, `e.clientY`)

2. **内联编辑不工作**
   - 检查 `isEditing` 状态切换
   - 确认 `editInputRef` 是否正确聚焦
   - 验证 `handleKeyDown` 事件处理

3. **图标选择器不展开**
   - 检查 `showIconSubmenu` 状态
   - 确认 `onMouseEnter/onMouseLeave` 事件
   - 验证二级菜单位置计算

4. **数据不更新**
   - 检查 `handleTaskUpdate` 函数传递
   - 确认 `setTasks` 状态更新
   - 验证任务 ID 匹配

**开发调试命令：**
```bash
pnpm run tauri dev  # 启动完整开发环境
pnpm run dev        # 仅启动前端开发服务器
pnpm run build      # 构建检查编译错误
```

---

**文档版本**：v2.0  
**创建日期**：2025-07-20  
**最后更新**：2025-07-20  
**实现状态**：✅ 已完成  
**负责人**：Claude Code 开发助手