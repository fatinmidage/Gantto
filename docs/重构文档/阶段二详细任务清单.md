# 阶段二详细任务清单：状态管理抽离

> **创建日期**: 2025-07-13  
> **优先级**: 🔴 高  
> **预估工期**: 5-7天  
> **风险等级**: 中等

## 🎯 阶段目标

将 `GanttChart.tsx` 中的复杂状态管理逻辑抽离到独立的自定义 Hooks 中，提升代码的可维护性和可测试性。

## 📋 任务分解

### 1. ✅ 基础设施建设 (Day 1) - **已完成 100%**

#### 1.1 ✅ 创建 Hooks 目录结构
- [x] 创建 `src/hooks/` 目录
- [x] 创建子目录结构：
  - `src/hooks/gantt/` - Gantt相关hooks
  - `src/hooks/common/` - 通用hooks
- [x] 创建统一导出文件 `src/hooks/index.ts`

#### 1.2 ✅ 分析现有状态逻辑
- [x] 分析 `GanttChart.tsx` 中的状态使用情况
- [x] 识别可抽离的状态逻辑模块：
  - 拖拽状态管理
  - 任务CRUD操作
  - 时间轴计算
  - UI状态管理

### 2. ✅ 拖拽逻辑抽离 (Day 2-3) - **已完成 100%**

#### 2.1 ✅ 创建 `useDragAndDrop` Hook
- [x] 抽离水平拖拽逻辑 (任务时间线调整)
- [x] 抽离垂直拖拽逻辑 (任务重排序)
- [x] 实现拖拽状态管理：
  ```typescript
  // 已实现完整的拖拽状态接口
  interface DragState {
    isDragging: boolean;
    dragType: 'move' | 'resize-left' | 'resize-right' | null;
    draggedTaskId: string | null;
    tempDragPosition: { id: string; x: number; width: number } | null;
    verticalDragState: VerticalDragState;
    // ... 完整状态管理
  }
  ```

#### 2.2 ✅ 性能优化逻辑抽离
- [x] 抽离 `useDragCache` 相关逻辑 (集成到 useDragAndDrop)
- [x] 创建 `useThrottledMouseMove` Hook (独立文件)
- [x] 保持现有性能优化特性

#### 2.3 ⏸️ 测试拖拽功能 (待主组件重构后)
- [ ] 验证水平拖拽功能正常
- [ ] 验证垂直拖拽功能正常
- [ ] 验证拖拽性能未降低

### 3. ✅ 任务管理逻辑抽离 (Day 3-4) - **已完成 100%**

#### 3.1 ✅ 创建 `useTaskManager` Hook
- [x] 抽离任务CRUD操作：
  - 添加任务 (`addTask`)
  - 删除任务 (`deleteTask`)
  - 更新任务 (`updateTask`)
  - 复制任务 (`duplicateTask`)
- [x] 抽离层级管理逻辑：
  - 展开/折叠 (`toggleExpand`)
  - 父子关系管理
  - 层级可见性计算

#### 3.2 ✅ 任务状态计算
- [x] 抽离可见任务计算 (`getVisibleTasks`)
- [x] 抽离父任务进度计算 (`calculateParentProgress`)
- [x] 抽离任务排序逻辑
- [x] 抽离所有子代行获取 (`getAllDescendantRows`)

#### 3.3 ⏸️ 数据持久化 (待主组件集成后验证)
- [ ] 保持现有的数据变更通知机制
- [ ] 确保状态同步正确性

### 4. ✅ 时间轴计算逻辑抽离 (Day 4-5) - **已完成 100%**

#### 4.1 ✅ 创建 `useTimeline` Hook
- [x] 抽离时间轴缩放逻辑：
  ```typescript
  // 已实现完整的时间轴状态管理
  interface DateRange {
    startDate: Date;
    endDate: Date;
    totalDays: number;
    pixelPerDay: number;
  }
  ```

#### 4.2 ✅ 日期计算函数
- [x] 抽离日期到像素转换 (`dateToPixel`)
- [x] 抽离像素到日期转换 (`pixelToDate`)
- [x] 抽离时间范围计算逻辑
- [x] 抽离缩放控制 (`handleZoomIn`, `handleZoomOut`)

#### 4.3 ✅ 视口管理
- [x] 抽离时间刻度显示逻辑 (`timeScales`)
- [x] 抽离可视区域计算 (`getVisibleDateRange`)
- [x] 抽离当前日期线位置计算
- [x] 抽离快速导航 (`handleViewToday`)

### 5. ✅ UI状态管理抽离 (Day 5-6) - **已完成 100%**

#### 5.1 ✅ 创建 `useGanttUI` Hook
- [x] 抽离选择状态管理 (title + chart 任务选择)
- [x] 抽离悬停状态管理
- [x] 抽离编辑模式状态

#### 5.2 ✅ 交互状态
- [x] 抽离右键菜单状态 (通用 + 任务专用)
- [x] 抽离颜色选择器状态
- [x] 抽离标签管理器状态
- [x] 抽离键盘快捷键处理

### 6. ✅ 通用工具 Hooks - **已完成 100%**
- [x] 创建 `useThrottle` Hook (通用节流)
- [x] 创建 `useCache` Hook (缓存和批量更新)

### 7. ⏸️ 重构主组件 (Day 6-7) - **待执行 0%**

#### 7.1 🔄 简化 `GanttChart.tsx`
- [ ] 导入新创建的自定义 Hooks
- [ ] 替换现有状态声明为 Hook 调用
- [ ] 移除已抽离的状态逻辑和函数
- [ ] 重构事件处理器使用 Hook 方法
- [ ] 保持组件API不变

#### 7.2 🔄 集成验证
- [ ] 分阶段替换状态逻辑（先 UI，后拖拽，最后任务管理）
- [ ] 每个阶段后验证编译和基本功能
- [ ] 修复集成过程中的问题

#### 7.3 🔄 类型安全检查
- [ ] 确保所有类型定义正确
- [ ] 使用 `src/types` 中的统一类型
- [ ] 通过 TypeScript 编译检查

#### 7.4 🔄 功能验证
- [ ] 所有现有功能正常工作
- [ ] 性能无明显降低
- [ ] 用户体验保持一致

## 🔍 验收标准

### 功能性验收
- [ ] 所有拖拽功能正常（水平、垂直）**[待主组件重构后验证]**
- [ ] 任务CRUD操作正常 **[待主组件重构后验证]**
- [ ] 层级展开/折叠功能正常 **[待主组件重构后验证]**
- [ ] 时间轴缩放功能正常 **[待主组件重构后验证]**
- [ ] 选择和编辑功能正常 **[待主组件重构后验证]**

### 代码质量验收
- [x] **TypeScript 编译无错误** ✅ (所有Hooks已通过编译)
- [ ] **代码可读性提升** ⏸️ (待主组件重构完成)
- [x] **职责分离清晰** ✅ (Hooks设计已实现清晰分离)
- [x] **自定义 Hooks 可复用** ✅ (设计已支持复用)

### 性能验收
- [ ] 拖拽操作流畅度保持 **[待主组件重构后验证]**
- [ ] 大数据量渲染性能无降低 **[待主组件重构后验证]**
- [ ] 内存使用无明显增加 **[待主组件重构后验证]**

## 📁 文件结构预期

```
src/hooks/                           ✅ 已创建
├── index.ts                         ✅ 统一导出 (已完成)
├── gantt/                           ✅ 已创建
│   ├── useDragAndDrop.ts           ✅ 拖拽逻辑 (已完成)
│   ├── useTaskManager.ts           ✅ 任务管理 (已完成)
│   ├── useTimeline.ts              ✅ 时间轴计算 (已完成)
│   └── useGanttUI.ts               ✅ UI状态管理 (已完成)
└── common/                          ✅ 已创建
    ├── useThrottle.ts              ✅ 通用节流hook (已完成)
    └── useCache.ts                 ✅ 通用缓存hook (已完成)
```

**所有Hook文件已创建完成，通过TypeScript编译验证！**

## ⚠️ 风险控制

### 主要风险点
1. **状态同步**: 多个Hook间的状态可能不同步
2. **性能回退**: 状态抽离可能影响性能优化
3. **类型复杂度**: Hook间的类型传递可能变复杂

### 缓解策略
1. 分步进行，每个Hook独立验证
2. 保持现有性能优化机制
3. 充分利用TypeScript类型检查
4. 随时可回滚到上一个稳定版本

## 📊 进度跟踪

- **开始日期**: 2025-07-13
- **当前状态**: 🟡 **进行中** (基础设施完成，准备主组件重构)
- **整体完成度**: **70%**

### 📈 详细进度
| 阶段 | 任务 | 状态 | 完成度 |
|------|------|------|--------|
| 1 | 基础设施建设 | ✅ 已完成 | 100% |
| 2 | 拖拽逻辑抽离 | ✅ 已完成 | 100% |
| 3 | 任务管理逻辑抽离 | ✅ 已完成 | 100% |
| 4 | 时间轴计算逻辑抽离 | ✅ 已完成 | 100% |
| 5 | UI状态管理抽离 | ✅ 已完成 | 100% |
| 6 | 通用工具Hooks | ✅ 已完成 | 100% |
| 7 | **主组件重构** | ⏸️ **待执行** | **0%** |

---

**✅ 当前成就**: 
- 所有自定义Hooks创建完成
- TypeScript编译验证通过
- 完整的状态管理架构就绪

**🔄 下一步动作**: 重构 `GanttChart.tsx` 主组件，集成新的自定义Hooks