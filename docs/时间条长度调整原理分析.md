# 时间条长度调整原理分析

## 📊 核心原理概述

甘特图中时间条（任务条）的长度调整基于**日期到像素的双向转换机制**，通过精确的坐标计算系统实现任务时间范围的可视化和交互。

## 🔧 核心算法架构

### 1. 双向转换机制
**日期 ⇄ 像素转换**：
- `dateToPixel(date: Date)`: 将日期转换为屏幕像素位置
- `pixelToDate(pixel: number)`: 将像素位置转换回日期
- **关键算法**：`pixelPosition = (日期差 × 像素密度) + 起始偏移`

### 2. 像素密度计算策略
```typescript
// 自适应像素密度：基于容器宽度动态计算
const pixelPerDay = containerWidth && totalDays > 0 
  ? containerWidth / totalDays           // 容器自适应模式
  : Math.max(1, 80 * zoomLevel);        // 固定缩放模式
```

### 3. 时间条长度计算
**任务条宽度**：
- 基础宽度 = `(结束日期 - 开始日期) × 每日像素密度`
- 中心点定位 = `起始日期像素位置 + 宽度/2`
- 渲染位置 = `中心点 - 宽度/2`（左边缘坐标）

## 🎯 三种调整模式

### 1. 整体移动（Move）
- **保持**：任务持续时间不变
- **改变**：开始和结束日期同时平移
- **计算**：`新位置 = 鼠标位置对应的日期`

### 2. 左边界调整（Resize-Left）
- **保持**：结束日期固定
- **改变**：开始日期，任务持续时间
- **计算**：`新开始日期 = 左边界像素位置对应的日期`

### 3. 右边界调整（Resize-Right）
- **保持**：开始日期固定
- **改变**：结束日期，任务持续时间
- **计算**：`新结束日期 = 右边界像素位置对应的日期`

## 🔄 实时更新流程

### 拖拽交互流程：
1. **mouseDown** → 检测拖拽类型（move/resize-left/resize-right）
2. **mouseMove** → 实时计算临时位置和预览
3. **mouseUp** → 确认最终位置，更新任务数据

### 边界检测机制：
- **边缘感应区**：8px边界检测区域
- **光标变化**：`w-resize` | `e-resize` | `grab`
- **视觉反馈**：实时预览和拖拽状态

## 📐 精度优化技术

### 1. UTC时间标准化
```typescript
// 避免时区影响的精确计算
const normalizedDate = new Date(Date.UTC(
  date.getFullYear(), 
  date.getMonth(), 
  date.getDate()
));
```

### 2. 像素对齐优化
```typescript
// 确保时间刻度线精确对齐
const pixelPosition = Math.round(dateToPixel(date));
```

### 3. 边界约束处理
- **容器边界**：防止拖拽超出可视区域
- **日期合理性**：确保开始日期 ≤ 结束日期
- **最小宽度**：保证任务条可见性

## 🏗️ 分层时间轴系统

### 多尺度时间显示：
- **年层**：年份标识和分隔
- **月层**：月份网格线和标签
- **周层**：周次详细划分
- **自适应切换**：根据缩放级别智能显示

### 时间轴层配置：
```typescript
interface TimelineLayerConfig {
  layerCount: number;           // 层数（2-4层）
  granularities: TimeGranularity[];  // 时间粒度组合
  isEnabled: boolean;          // 是否启用分层模式
}
```

## 💡 性能优化策略

### 1. 计算缓存
- **memo化转换函数**：避免重复计算
- **批量更新**：减少DOM操作频率

### 2. 节流处理
- **mousemove事件节流**：提升拖拽流畅度
- **实时预览优化**：降低计算负载

### 3. 边界预计算
- **可视区域检测**：只渲染可见任务
- **智能裁剪**：减少无效绘制

## 🎨 视觉反馈系统

### 拖拽状态指示：
- **hover效果**：边界高亮和光标变化
- **拖拽预览**：半透明临时位置
- **约束提示**：边界限制视觉反馈

### 精度指示器：
- **时间网格**：辅助对齐参考线
- **日期提示**：实时显示当前日期
- **持续时间显示**：动态计算任务长度

## 🔧 关键实现文件

### 核心Hook文件：
- `src/hooks/gantt/useTimeline.ts` - 时间轴核心逻辑
- `src/hooks/gantt/useHorizontalDrag.ts` - 水平拖拽处理
- `src/hooks/gantt/useLayeredTimeline.ts` - 分层时间轴

### 工具函数：
- `src/utils/timelineLayerUtils.ts` - 时间层计算工具
- `src/utils/coordinateUtils.ts` - 坐标转换工具
- `src/utils/boundaryUtils.ts` - 边界约束工具

### 核心组件：
- `src/components/gantt/TaskBar.tsx` - 任务条组件
- `src/components/gantt/LayeredTimelineHeader.tsx` - 分层时间轴头部
- `src/components/gantt/GanttChartBody.tsx` - 甘特图主体

## 📏 精确度控制

### 日期计算精度：
- **毫秒级精度**：内部计算使用毫秒时间戳
- **日级显示**：用户界面按日期显示
- **UTC标准化**：避免时区导致的偏差

### 像素精度控制：
- **亚像素渲染**：支持小数像素位置
- **网格对齐**：重要节点对齐到时间网格
- **边界修正**：避免显示错位

## 🚀 扩展性设计

### 可配置参数：
- **时间粒度**：支持天、周、月、季度、年
- **像素密度**：可调整的缩放级别
- **边界检测**：可配置的感应区域大小

### 插件化架构：
- **拖拽插件**：模块化的拖拽处理器
- **约束插件**：可扩展的边界约束规则
- **渲染插件**：自定义的视觉效果

---

这套系统通过精确的数学模型、高效的算法实现和丰富的交互反馈，为用户提供直观、精确的甘特图时间管理体验。