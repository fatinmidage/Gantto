# 阶段一：数据模型统一 - 详细任务清单

> **目标**: 解决数据结构混乱问题，建立统一、清晰的数据模型  
> **预估工期**: 3-5天  
> **风险等级**: 低  
> **优先级**: 🔴 高

## 📋 任务分解

### 🔍 **任务1: 分析现有数据结构**
**优先级**: 🔴 高  
**预估时间**: 0.5天  
**负责人**: 开发者  

#### 具体步骤
1. **梳理GanttChart.tsx中的所有接口定义**
   - [ ] 定位 `ProjectRow` 接口 (约第9行)
   - [ ] 定位 `ChartTask` 接口 (约第21行)  
   - [ ] 定位 `Task` 接口 (约第37行)
   - [ ] 定位其他相关类型定义

2. **分析接口间的重复字段**
   ```typescript
   // 需要分析的重复字段
   - id: string          // 三个接口都有
   - title: string       // 三个接口都有  
   - type?: TaskType     // 三个接口都有
   - 时间相关字段的差异
   - 层级关系字段的差异
   ```

3. **识别业务逻辑差异**
   - [ ] `ProjectRow` 的用途：左侧任务列表显示
   - [ ] `ChartTask` 的用途：右侧图表绘制
   - [ ] `Task` 的用途：兼容性接口（临时）

4. **记录数据流向**
   - [ ] 数据如何在三种类型间转换
   - [ ] 哪些组件使用了哪种类型
   - [ ] 存在哪些类型转换函数

#### 产出物
- `现有数据结构分析报告.md`
- 重复字段对比表
- 数据流向图

---

### 🎯 **任务2: 设计统一的数据模型架构**
**优先级**: 🔴 高  
**预估时间**: 1天  
**负责人**: 开发者

#### 具体步骤
1. **设计核心数据模型**
   ```typescript
   // 设计原则
   - 单一数据源 (Single Source of Truth)
   - 关注点分离 (Separation of Concerns)
   - 向后兼容 (Backward Compatibility)
   ```

2. **确定主要实体**
   - [ ] **Task** - 核心任务实体
   - [ ] **Project** - 项目实体  
   - [ ] **Timeline** - 时间轴配置
   - [ ] **UIState** - 界面状态

3. **设计实体关系**
   ```typescript
   Task {
     id: string
     projectId: string  // 关联项目
     // ... 其他核心字段
   }
   
   ProjectRow {
     id: string
     taskId?: string    // 可选关联任务
     // ... UI特定字段
   }
   ```

4. **定义数据转换策略**
   - [ ] Task -> ProjectRow 的转换逻辑
   - [ ] Task -> ChartTask 的转换逻辑
   - [ ] 兼容现有代码的迁移路径

#### 产出物
- `统一数据模型设计.md`
- TypeScript接口草图
- 数据转换策略文档

---

### 📁 **任务3: 创建types目录和基础类型文件**
**优先级**: 🔴 高  
**预估时间**: 0.5天  
**负责人**: 开发者

#### 具体步骤
1. **创建目录结构**
   ```
   src/types/
   ├── index.ts        # 统一导出文件
   ├── task.ts         # 任务相关类型
   ├── project.ts      # 项目相关类型
   ├── ui.ts          # UI状态类型
   ├── timeline.ts     # 时间轴类型
   └── common.ts       # 通用类型
   ```

2. **设置基础导出结构**
   ```typescript
   // index.ts
   export * from './task';
   export * from './project';
   export * from './ui';
   export * from './timeline';
   export * from './common';
   ```

3. **创建通用类型定义**
   ```typescript
   // common.ts
   export type TaskType = 'milestone' | 'development' | 'testing' | 'delivery' | 'default';
   export type TaskStatus = 'pending' | 'in-progress' | 'completed' | 'overdue';
   
   export interface Position {
     x: number;
     y: number;
   }
   
   export interface Size {
     width: number;
     height: number;
   }
   ```

#### 验收标准
- [ ] 目录结构创建完成
- [ ] 所有文件可以正常导入
- [ ] TypeScript编译无错误

---

### 📝 **任务4: 定义核心Task接口**
**优先级**: 🔴 高  
**预估时间**: 1天  
**负责人**: 开发者

#### 具体步骤
1. **定义基础Task接口**
   ```typescript
   // task.ts
   import { TaskType, TaskStatus } from './common';
   
   export interface Task {
     // 基础信息
     id: string;
     title: string;
     description?: string;
     
     // 时间信息
     startDate: Date;
     endDate: Date;
     
     // 状态信息
     type: TaskType;
     status: TaskStatus;
     progress: number; // 0-100
     
     // 层级关系
     parentId?: string;
     children: string[];
     level: number;
     
     // 显示属性
     color: string;
     tags: string[];
     
     // 元数据
     createdAt: Date;
     updatedAt: Date;
     createdBy?: string;
   }
   ```

2. **定义任务相关的辅助类型**
   ```typescript
   export interface TaskCreateInput {
     title: string;
     startDate: Date;
     endDate: Date;
     type?: TaskType;
     parentId?: string;
     color?: string;
   }
   
   export interface TaskUpdateInput {
     title?: string;
     startDate?: Date;
     endDate?: Date;
     status?: TaskStatus;
     progress?: number;
     color?: string;
     tags?: string[];
   }
   ```

3. **定义任务层级相关类型**
   ```typescript
   export interface TaskHierarchy {
     task: Task;
     children: TaskHierarchy[];
     depth: number;
     isExpanded: boolean;
   }
   
   export interface TaskTreeNode {
     id: string;
     parentId?: string;
     children: string[];
     isLeaf: boolean;
     path: string[]; // 从根到当前节点的路径
   }
   ```

#### 验收标准
- [ ] Task接口定义完整
- [ ] 辅助类型定义合理
- [ ] 与现有数据结构兼容
- [ ] TypeScript类型检查通过

---

### 🏗️ **任务5: 定义ProjectRow接口**
**优先级**: 🟡 中  
**预估时间**: 0.5天  
**负责人**: 开发者

#### 具体步骤
1. **定义ProjectRow接口**
   ```typescript
   // project.ts
   export interface ProjectRow {
     // 行标识
     id: string;
     
     // 关联任务
     taskId?: string; // 可选，有些行可能只是分组
     
     // 显示属性
     title: string;
     order: number;    // 显示顺序
     level: number;    // 缩进层级
     
     // 状态
     isExpanded: boolean;
     isVisible: boolean;
     
     // 层级关系（与Task分离）
     parentRowId?: string;
     childRowIds: string[];
     
     // UI特定属性
     height: number;
     isSelected: boolean;
     isHovered: boolean;
   }
   ```

2. **定义项目配置接口**
   ```typescript
   export interface ProjectConfig {
     id: string;
     name: string;
     description?: string;
     startDate: Date;
     endDate: Date;
     createdAt: Date;
     updatedAt: Date;
   }
   
   export interface ProjectData {
     config: ProjectConfig;
     tasks: Task[];
     rows: ProjectRow[];
   }
   ```

#### 验收标准
- [ ] ProjectRow与Task解耦
- [ ] 支持现有的层级显示逻辑
- [ ] 与UI组件需求匹配

---

### 🎨 **任务6: 定义UI状态相关类型**
**优先级**: 🟡 中  
**预估时间**: 0.5天  
**负责人**: 开发者

#### 具体步骤
1. **定义拖拽状态类型**
   ```typescript
   // ui.ts
   export interface DragState {
     isDragging: boolean;
     dragType: 'horizontal' | 'vertical' | null;
     draggedItemId: string | null;
     startPosition: Position;
     currentPosition: Position;
     targetPosition?: Position;
   }
   
   export interface VerticalDragState {
     isDragging: boolean;
     draggedTaskId: string | null;
     draggedTaskIndex: number | null;
     targetIndex: number | null;
     startY: number;
     currentY: number;
     shouldShowIndicator: boolean;
   }
   ```

2. **定义选择和交互状态**
   ```typescript
   export interface SelectionState {
     selectedTaskIds: Set<string>;
     selectedRowIds: Set<string>;
     lastSelectedId: string | null;
     selectionMode: 'single' | 'multiple';
   }
   
   export interface InteractionState {
     hoveredTaskId: string | null;
     hoveredRowId: string | null;
     focusedElementId: string | null;
   }
   ```

3. **定义右键菜单和弹窗状态**
   ```typescript
   export interface ContextMenuState {
     visible: boolean;
     position: Position;
     targetId: string | null;
     menuType: 'task' | 'row' | 'timeline';
   }
   
   export interface ModalState {
     colorPicker: {
       visible: boolean;
       taskId: string | null;
     };
     tagManager: {
       visible: boolean;
       taskId: string | null;
       newTag: string;
     };
   }
   ```

#### 验收标准
- [ ] 覆盖所有UI交互状态
- [ ] 类型定义清晰易懂
- [ ] 便于状态管理

---

### 🔄 **任务7: 更新GanttChart.tsx中的类型引用**
**优先级**: 🔴 高  
**预估时间**: 1天  
**负责人**: 开发者

#### 具体步骤
1. **添加新的类型导入**
   ```typescript
   // 在GanttChart.tsx顶部添加
   import {
     Task,
     ProjectRow,
     TaskCreateInput,
     TaskUpdateInput,
     DragState,
     SelectionState,
     // ... 其他需要的类型
   } from '../types';
   ```

2. **逐步替换现有类型使用**
   - [ ] 替换所有 `Task[]` 类型的声明
   - [ ] 替换所有 `ProjectRow[]` 类型的声明
   - [ ] 更新函数参数和返回值类型
   - [ ] 更新useState的类型注解

3. **保持向后兼容**
   ```typescript
   // 临时保留旧接口，添加 @deprecated 注解
   /** @deprecated 使用新的 Task 类型替代 */
   interface OldTask extends Task {
     // 兼容性字段
   }
   ```

4. **更新相关的辅助函数**
   - [ ] 更新类型转换函数
   - [ ] 更新数据验证函数
   - [ ] 更新工具函数的类型注解

#### 验收标准
- [ ] 所有类型引用更新完成
- [ ] TypeScript编译无错误
- [ ] 保持现有功能不变

---

### 🧹 **任务8: 移除重复的接口定义**
**优先级**: 🟡 中  
**预估时间**: 0.5天  
**负责人**: 开发者

#### 具体步骤
1. **确认新类型使用正常**
   - [ ] 运行TypeScript编译检查
   - [ ] 运行基础功能测试
   - [ ] 确认IDE智能提示正常

2. **逐步移除旧接口定义**
   ```typescript
   // 移除这些重复定义
   // interface ProjectRow { ... }     // 第9行附近
   // interface ChartTask { ... }      // 第21行附近  
   // interface Task { ... }           // 第37行附近
   ```

3. **清理相关的注释**
   - [ ] 移除"兼容性类型"相关注释
   - [ ] 移除"临时接口"相关注释
   - [ ] 更新文档注释

4. **整理导入语句**
   - [ ] 移除未使用的类型导入
   - [ ] 整理import语句顺序
   - [ ] 添加必要的类型导入

#### 验收标准
- [ ] 所有重复接口定义已移除
- [ ] 代码整洁，无冗余类型
- [ ] 编译和功能正常

---

### ✅ **任务9: 验证编译无错误**
**优先级**: 🔴 高  
**预估时间**: 0.5天  
**负责人**: 开发者

#### 具体步骤
1. **TypeScript编译检查**
   ```bash
   # 运行TypeScript编译
   pnpm run build
   
   # 检查类型错误
   npx tsc --noEmit
   ```

2. **修复编译错误**
   - [ ] 识别所有类型错误
   - [ ] 逐一修复类型不匹配问题
   - [ ] 确保没有any类型的滥用

3. **IDE智能提示验证**
   - [ ] 验证代码自动补全正常
   - [ ] 验证类型提示准确
   - [ ] 验证重构功能可用

4. **依赖检查**
   - [ ] 确认所有模块导入正常
   - [ ] 检查循环依赖问题
   - [ ] 验证外部库类型兼容

#### 验收标准
- [ ] TypeScript编译成功
- [ ] 无类型错误和警告
- [ ] IDE智能提示正常

---

### 🧪 **任务10: 功能测试验证**
**优先级**: 🔴 高  
**预估时间**: 0.5天  
**负责人**: 开发者

#### 具体步骤
1. **基础功能测试**
   ```bash
   # 启动开发服务器
   pnpm run tauri dev
   ```

2. **核心功能验证**
   - [ ] 任务列表正常显示
   - [ ] 甘特图渲染正确
   - [ ] 拖拽功能正常
   - [ ] 右键菜单功能正常
   - [ ] 任务创建/编辑功能正常

3. **数据一致性检查**
   - [ ] 任务数据在组件间传递正确
   - [ ] 状态更新反映到UI
   - [ ] 层级关系显示正确

4. **性能基准测试**
   - [ ] 页面加载时间
   - [ ] 大量任务渲染性能
   - [ ] 拖拽操作响应时间

#### 验收标准
- [ ] 所有现有功能正常工作
- [ ] 无明显的性能回退
- [ ] 用户体验保持一致

---

## 📊 执行时间表

| 任务 | 预估时间 | 依赖关系 | 里程碑 |
|------|----------|----------|---------|
| 任务1-2 | 1.5天 | 无 | 完成设计阶段 |
| 任务3-4 | 1.5天 | 依赖任务2 | 核心类型定义完成 |
| 任务5-6 | 1天 | 依赖任务4 | 所有类型定义完成 |
| 任务7-8 | 1.5天 | 依赖任务6 | 代码迁移完成 |
| 任务9-10 | 1天 | 依赖任务8 | 验证通过，阶段完成 |

**总计**: 6天（考虑缓冲时间）

## ✅ 完成标准

### 技术指标
- [ ] TypeScript编译零错误
- [ ] 所有现有功能正常工作
- [ ] 代码中无重复的类型定义
- [ ] IDE智能提示准确

### 质量指标  
- [ ] 类型覆盖率100%
- [ ] 无any类型滥用
- [ ] 接口设计符合最佳实践
- [ ] 代码可读性提升

### 文档指标
- [ ] 类型定义有完整的注释
- [ ] 更新相关的技术文档
- [ ] 提供数据模型使用示例

## 🔄 后续计划

完成阶段一后，团队可以选择：

1. **继续阶段二**: 状态管理抽离
2. **暂停重构**: 专注业务功能开发  
3. **评估效果**: 根据实际效果调整后续计划

---

**文档版本**: v1.0  
**创建时间**: 2025-07-13  
**更新时间**: 待更新