# 时间轴完整显示需求分析与任务清单

## 需求概述

实现时间轴 TimelineHeader 从用户通过 DateRangePicker 选择的起始日期开始，一直到结束日期完整显示，替换当前基于固定偏移量的显示逻辑。

## 详细需求分析

### 1. 核心功能变更

#### 1.1 时间轴范围显示
- **当前状态**: 基于固定偏移量显示（前90天到后180天）
- **目标状态**: 严格按照 DateRangePicker 选择的起始/结束日期显示
- **边界处理**: 严格模式，不做边界对齐，精确从选择的日期开始和结束

#### 1.2 宽度计算逻辑
- **当前逻辑**: `pixelPerDay = 80 * zoomLevel`（固定像素密度）
- **新逻辑**: `pixelPerDay = 容器宽度 / 总天数`（完全自适应）
- **含义**: 取消 zoomLevel 概念，改为自适应宽度计算

#### 1.3 响应式行为
- **窗口变化**: 浏览器窗口大小变化时重新计算 pixelPerDay
- **动态调整**: 保持时间轴始终填满容器宽度

### 2. 数据处理策略

#### 2.1 数据优先级
- **绝对准则**: DateRangePicker 选择的日期范围为最高优先级
- **任务处理**: 超出选择范围的任务不在时间轴上显示
- **数据一致性**: 以用户选择为准，不自动扩展范围

#### 2.2 默认值策略
- **采用标准**: 使用 GanttChart.tsx 的默认逻辑
- **默认范围**: 当前日期前30天到后150天（总计180天）
- **初始状态**: 项目启动时使用此默认范围

### 3. 用户界面行为

#### 3.1 时间颗粒度控制
- **保持手动**: 取消自动颗粒度调整功能
- **用户选择**: 保留 TimeGranularitySelector 的手动选择功能
- **可选项**: 日/周/月/季度/年 五种颗粒度

#### 3.2 当前日期线显示
- **显示条件**: 仅当当前日期在选择范围内时显示
- **隐藏处理**: 当前日期超出选择范围时隐藏红色指示线
- **无提示**: 不在边界显示任何提示信息

#### 3.3 任务条渲染
- **最小宽度**: 不设置最小宽度限制
- **自然宽度**: 任务条可以根据时间长度显示为很窄的条形
- **适应性**: 完全基于新的宽度计算逻辑

### 4. 视图约束

#### 4.1 滚动限制
- **无横向滚动**: 甘特图不能横向滚动
- **固定显示**: 只显示用户选择的日期范围
- **调整方式**: 仅通过时间颗粒度改变显示密度

#### 4.2 容器适配
- **宽度填满**: 时间轴始终填满容器宽度
- **动态调整**: 容器宽度变化时实时重计算

## 技术实现分析

### 1. 核心文件修改

#### 1.1 useTimeline.ts（主要修改）
- **移除**: zoomLevel 相关的 pixelsPerDay 计算逻辑
- **新增**: 基于容器宽度的自适应计算
- **修改**: dateRange 计算完全使用传入的日期参数
- **优化**: 时间刻度生成严格按照日期范围

#### 1.2 TimelineHeader.tsx（次要修改）
- **修改**: 当前日期线显示条件
- **确保**: 时间刻度渲染适配新的宽度计算

#### 1.3 GanttChart.tsx（配置调整）
- **确认**: 默认日期范围逻辑
- **验证**: 日期范围传递到下层组件

### 2. 计算逻辑重构

#### 2.1 日期范围计算
```typescript
// 当前逻辑
const start = initialStartDate || new Date(Date.now() - 90 * 24 * 60 * 60 * 1000);
const end = initialEndDate || new Date(Date.now() + 180 * 24 * 60 * 60 * 1000);

// 目标逻辑
const start = initialStartDate; // 直接使用传入的日期
const end = initialEndDate;     // 直接使用传入的日期
```

#### 2.2 像素密度计算
```typescript
// 当前逻辑
const pixelPerDay = Math.max(1, 80 * zoomLevel);

// 目标逻辑
const pixelPerDay = containerWidth / totalDays;
```

#### 2.3 容器宽度监听
- **新增**: 容器宽度变化监听机制
- **实时**: 窗口 resize 时重新计算 pixelPerDay
- **响应式**: 确保时间轴始终适配容器

### 3. 边界条件处理

#### 3.1 当前日期线
```typescript
// 新增显示条件检查
const today = new Date();
const shouldShowCurrentLine = today >= dateRange.startDate && today <= dateRange.endDate;
```

#### 3.2 任务过滤
- **范围检查**: 任务的开始或结束日期是否在选择范围内
- **显示逻辑**: 完全不在范围内的任务不渲染

## 实现任务清单

### 阶段一：核心逻辑重构（高优先级）

#### 任务1: 修改 useTimeline.ts 的日期范围计算
- [ ] 移除固定偏移量逻辑（前90天后180天）
- [ ] 直接使用传入的 initialStartDate 和 initialEndDate
- [ ] 确保 dateRange 计算完全基于传入参数

#### 任务2: 重构像素密度计算逻辑
- [ ] 移除 zoomLevel 相关的 pixelsPerDay 计算
- [ ] 实现基于容器宽度的自适应计算：`pixelPerDay = containerWidth / totalDays`
- [ ] 移除或重构 handleZoomIn、handleZoomOut 等缩放相关方法

#### 任务3: 修改时间刻度生成逻辑
- [ ] 确保时间刻度严格从 dateRange.startDate 开始
- [ ] 确保时间刻度严格在 dateRange.endDate 结束
- [ ] 验证所有时间颗粒度（日/周/月/季度/年）的生成逻辑

### 阶段二：容器宽度适配（高优先级）

#### 任务4: 实现容器宽度监听
- [ ] 添加容器宽度变化的监听机制
- [ ] 实现窗口 resize 时的 pixelPerDay 重计算
- [ ] 确保时间轴宽度始终匹配容器宽度

#### 任务5: 更新 dateToPixel 和 pixelToDate 方法
- [ ] 基于新的 pixelPerDay 计算更新转换方法
- [ ] 确保日期像素转换的准确性
- [ ] 验证拖拽功能的日期计算正确性

### 阶段三：UI组件更新（中优先级）

#### 任务6: 修改当前日期线显示逻辑
- [ ] 在 TimelineHeader.tsx 中添加日期范围检查
- [ ] 实现当前日期超出范围时隐藏红色指示线
- [ ] 测试各种日期范围下的显示效果

#### 任务7: 验证任务条渲染
- [ ] 确保任务条基于新的宽度计算正确显示
- [ ] 验证任务条在极窄情况下的显示效果
- [ ] 测试任务拖拽功能的正确性

### 阶段四：功能清理与优化（低优先级）

#### 任务8: 清理冗余的缩放功能
- [ ] 移除或隐藏缩放相关的UI控件
- [ ] 清理 zoomLevel 相关的状态管理
- [ ] 更新相关的类型定义和接口

#### 任务9: 更新默认值处理
- [ ] 确认 GanttChart.tsx 中的默认日期范围逻辑
- [ ] 验证默认值与 DateRangePicker 的集成
- [ ] 测试初始加载时的显示效果

### 阶段五：测试与验证（中优先级）

#### 任务10: 功能测试
- [ ] 测试各种日期范围选择的显示效果
- [ ] 测试不同时间颗粒度下的时间轴显示
- [ ] 测试容器宽度变化时的响应式行为

#### 任务11: 边界情况测试
- [ ] 测试极短时间范围（1-3天）的显示
- [ ] 测试极长时间范围（5-10年）的显示
- [ ] 测试当前日期在/不在选择范围内的情况

#### 任务12: 集成测试
- [ ] 测试 DateRangePicker 与时间轴的集成
- [ ] 测试任务拖拽功能的正确性
- [ ] 测试整体用户交互流程

## 风险分析与注意事项

### 1. 技术风险
- **性能影响**: 容器宽度频繁变化可能影响性能，需要适当的防抖处理
- **计算精度**: 像素到日期的转换可能存在精度问题，需要仔细测试
- **依赖关系**: 多个组件依赖 useTimeline 的返回值，需要确保向后兼容性

### 2. 用户体验风险
- **极端情况**: 很长的时间范围可能导致任务条过窄，影响可读性
- **功能缺失**: 移除缩放功能可能影响用户的使用习惯
- **响应延迟**: 频繁的重计算可能导致界面更新延迟

### 3. 兼容性风险
- **现有数据**: 需要确保现有的任务数据能够正确显示
- **API变更**: useTimeline hook 的 API 变更可能影响其他组件
- **类型定义**: TypeScript 类型定义需要同步更新

## 验收标准

### 1. 功能验收
- [ ] 时间轴严格按照 DateRangePicker 选择的日期范围显示
- [ ] 时间轴宽度始终填满容器宽度
- [ ] 容器宽度变化时时间轴能够正确响应
- [ ] 当前日期线仅在日期范围内时显示

### 2. 性能验收
- [ ] 容器宽度变化时的响应时间 < 100ms
- [ ] 时间刻度生成性能满足要求
- [ ] 没有明显的界面卡顿或闪烁

### 3. 兼容性验收
- [ ] 现有的任务拖拽功能正常工作
- [ ] TimeGranularitySelector 功能正常
- [ ] 与其他组件的集成无问题

---

**文档版本**: v1.0  
**创建时间**: 2025-07-19  
**最后更新**: 2025-07-19  
**状态**: 待实现