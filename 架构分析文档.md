# Gantto 甘特图应用代码架构分析

## 技术栈概览
- **前端框架**: React 18 + TypeScript + Vite
- **后端**: Tauri v2 (Rust)
- **UI组件库**: Radix UI
- **图标库**: Lucide React
- **包管理器**: pnpm

## 核心架构模式

### 1. 分层架构设计
```
应用层 (App.tsx)
├─ 表现层 (Components)
├─ 业务逻辑层 (Hooks)
├─ 数据访问层 (Types/Utils)
└─ 基础设施层 (Styles/Assets)
```

### 2. 组件架构

#### 应用入口层 `src/App.tsx:1`
- **功能**: 应用根组件，全局错误处理
- **职责**: 
  - 项目操作（新建/打开/保存）的接口定义
  - 全局错误边界管理
  - 甘特图组件的懒加载预加载

#### 核心甘特图组件 `src/components/GanttChart.tsx:16`
- **功能**: 甘特图主组件
- **状态管理**: 
  - 日期范围控制 (dateRangeStart/End)
  - 时间颗粒度控制 (timeGranularity)
- **组件组合**: 通过 GanttStateManager、GanttEventCoordinator、GanttContainer 实现

#### 甘特图子系统架构 `src/components/gantt/`

**状态管理层** `src/components/gantt/GanttStateManager.tsx:1`
- **功能**: 统一状态管理中心
- **集成Hooks**: 拖拽、任务管理、时间轴、筛选、UI状态、事件处理
- **数据处理**: 可见项目行计算、布局常量管理

**容器组件层** `src/components/gantt/GanttContainer.tsx:1`
- **功能**: 布局容器和事件分发
- **组件组合**: GanttChartHeader + GanttChartBody + GanttMenuManager
- **接口定义**: 任务CRUD操作、日期范围控制、拖拽状态管理

**渲染层组件**:
- `GanttChartHeader`: 时间轴头部渲染
- `GanttChartBody`: 甘特图主体渲染
- `TaskBars`: 任务条形图渲染
- `TaskTitleColumn`: 任务标题列
- `TimelineHeader`: 时间线头部

### 3. 业务逻辑层 (Hooks系统) `src/hooks/index.ts:1`

#### 核心功能模块
- **任务管理**: `useTaskManager`, `useTaskCRUD`, `useTaskBatch`
- **拖拽交互**: `useDragAndDrop`, `useHorizontalDrag`, `useVerticalDrag`
- **时间轴**: `useTimeline`, `useGanttCalculations`
- **UI状态**: `useGanttUI`, `useGanttUIState`
- **事件处理**: `useGanttEvents`, `useGanttMouseEvents`, `useGanttKeyboard`

#### 高级功能模块
- **层级管理**: `useTaskHierarchy`
- **选择机制**: `useTaskSelection`
- **上下文菜单**: `useContextMenus`, `useGanttContextMenu`
- **标签系统**: `useGlobalTags`

### 4. 数据模型层 `src/types/`

#### 核心数据类型 `src/types/task.ts:9`
```typescript
interface Task {
  // 基础信息: id, title, description
  // 时间信息: startDate, endDate
  // 状态信息: type, status, progress
  // 层级关系: parentId, children, level
  // 显示属性: color, tags, order
  // UI状态: isExpanded
  // 计算属性: x, width (图表绘制)
}
```

#### 类型体系
- **任务类型**: `task.ts` - 任务数据模型
- **项目类型**: `project.ts` - 项目结构定义
- **UI状态**: `ui.ts` - 拖拽、选择、菜单状态
- **时间轴**: `timeline.ts` - 时间配置和度量
- **拖拽**: `drag.ts` - 拖拽操作状态

### 5. 工具函数层
- **甘特图工具**: `src/utils/ganttUtils.ts` - 日期计算、位置转换
- **映射工具**: `src/utils/taskProjectRowMapping.ts` - 任务项目行映射

### 6. 样式系统 `src/styles/`
- **模块化CSS**: 按组件和功能分类
- **响应式设计**: `responsive.css`
- **动画效果**: `animations.css`

## 架构特点

### 优势
1. **高度模块化**: 功能按领域清晰分离
2. **Hook驱动**: 业务逻辑完全解耦
3. **类型安全**: 完整的TypeScript类型体系
4. **性能优化**: 懒加载、节流等优化措施

### 组件间通信模式
1. **状态管理**: 通过GanttStateManager集中管理
2. **事件协调**: 通过GanttEventCoordinator处理
3. **数据流**: 单向数据流，props下传，事件上冒泡

### 核心功能实现
1. **任务层级**: 支持父子关系和展开/折叠
2. **拖拽交互**: 水平时间调整和垂直排序
3. **时间轴**: 多粒度时间显示和导航
4. **视觉反馈**: 进度条、状态指示、当前日期线

## 组件详细说明

### 核心组件模块

#### 1. 应用层组件
- **App.tsx**: 应用根组件，管理全局状态和错误边界
- **Header.tsx**: 应用头部，提供项目操作按钮
- **Toolbar.tsx**: 工具栏，包含视图控制和缩放功能

#### 2. 甘特图核心组件
- **GanttChart.tsx**: 主甘特图组件，管理日期范围和时间颗粒度
- **GanttChartLazy.tsx**: 懒加载包装器，优化首屏加载性能
- **LazyWrapper.tsx**: 通用懒加载组件

#### 3. 甘特图子系统组件
- **GanttStateManager.tsx**: 状态管理中心，集成所有业务逻辑Hooks
- **GanttEventCoordinator.tsx**: 事件协调器，处理组件间事件通信
- **GanttContainer.tsx**: 布局容器，组合头部和主体组件
- **GanttDataProvider.tsx**: 数据提供者，管理数据上下文
- **GanttEventHandler.tsx**: 事件处理器，统一事件处理逻辑

#### 4. 渲染层组件
- **GanttChartHeader.tsx**: 甘特图头部渲染
- **GanttChartBody.tsx**: 甘特图主体渲染
- **TimelineHeader.tsx**: 时间线头部组件
- **TaskBars.tsx**: 任务条形图渲染组件
- **TaskTitleColumn.tsx**: 任务标题列组件

#### 5. 交互组件
- **TaskIcon.tsx**: 任务图标和拖拽手柄
- **TaskIconSelector.tsx**: 任务图标选择器
- **ColorPicker.tsx**: 颜色选择器
- **DateRangePicker.tsx**: 日期范围选择器
- **TimeGranularitySelector.tsx**: 时间颗粒度选择器

#### 6. 菜单和管理组件
- **GanttContextMenu.tsx**: 甘特图上下文菜单
- **TaskContextMenu.tsx**: 任务上下文菜单（甘特图区域）
- **TaskTitleContextMenu.tsx**: 任务标题右键菜单（新增 2025-07-20）
- **GanttMenuManager.tsx**: 菜单管理器
- **TagManager.tsx**: 标签管理器

#### 7. 层级控制组件
- **TaskHierarchyControls.tsx**: 任务层级控制组件
- **TaskTitleItem.tsx**: 任务标题项组件

#### 8. 工具组件
- **ErrorBoundary.tsx**: 错误边界组件
- **icons/index.ts**: 图标组件集合

### Hook系统详细说明

#### 1. 核心状态管理Hooks
- **useGanttState.tsx**: 甘特图主状态管理
- **useGanttUIState.tsx**: UI状态管理
- **useTaskManager.tsx**: 任务管理核心逻辑

#### 2. 任务操作Hooks
- **useTaskCRUD.tsx**: 任务增删改查操作
- **useTaskBatch.tsx**: 批量任务操作
- **useTaskEditor.tsx**: 任务编辑功能
- **useTaskHierarchy.tsx**: 任务层级管理
- **useTaskAttributes.tsx**: 任务属性管理
- **useTaskSelection.tsx**: 任务选择机制
- **useTaskFilter.tsx**: 任务筛选功能

#### 3. 拖拽系统Hooks
- **useDragAndDrop.tsx**: 拖拽主逻辑
- **useDragReducer.tsx**: 拖拽状态管理
- **useHorizontalDrag.tsx**: 水平拖拽（时间调整）
- **useVerticalDrag.tsx**: 垂直拖拽（排序）
- **useThrottledMouseMove.tsx**: 节流鼠标移动事件

#### 4. 事件处理Hooks
- **useGanttEvents.tsx**: 甘特图事件处理
- **useGanttMouseEvents.tsx**: 鼠标事件处理
- **useGanttKeyboard.tsx**: 键盘事件处理
- **useGanttInteractions.tsx**: 交互逻辑管理
- **useGanttHandlers.tsx**: 事件处理器集合

#### 5. UI控制Hooks
- **useGanttUI.tsx**: UI控制逻辑
- **useGanttCalculations.tsx**: 甘特图计算逻辑
- **useTimeline.tsx**: 时间轴管理
- **useTitleColumnResize.tsx**: 标题列调整大小

#### 6. 菜单系统Hooks
- **useContextMenus.tsx**: 上下文菜单管理
- **useGanttContextMenu.tsx**: 甘特图上下文菜单

#### 7. 全局功能Hooks
- **useGlobalTags.tsx**: 全局标签系统
- **useErrorHandler.tsx**: 错误处理
- **useThrottle.tsx**: 节流工具
- **useCache.tsx**: 缓存工具

### 类型系统说明

#### 1. 核心数据类型
- **task.ts**: 任务数据模型，包含完整的任务信息结构
- **project.ts**: 项目相关类型定义
- **common.ts**: 通用类型定义（TaskType、TaskStatus等）

#### 2. UI状态类型
- **ui.ts**: UI状态类型（拖拽、选择、菜单状态）
- **drag.ts**: 拖拽操作相关类型
- **timeline.ts**: 时间轴配置和度量类型

#### 3. 甘特图类型
- **gantt.ts**: 甘特图特定类型定义

### 工具函数说明

#### 1. 甘特图工具函数 `src/utils/ganttUtils.ts`
- 日期计算和转换
- 像素位置计算
- 任务定位算法

#### 2. 任务映射工具 `src/utils/taskProjectRowMapping.ts`
- 任务与项目行的映射关系
- 层级结构处理

### 样式系统说明

#### 1. 基础样式
- **base.css**: 基础样式定义
- **index.css**: 全局样式入口
- **layout.css**: 布局相关样式
- **responsive.css**: 响应式设计
- **animations.css**: 动画效果

#### 2. 组件样式
- **buttons.css**: 按钮样式
- **gantt.css**: 甘特图主要样式
- **tasks.css**: 任务相关样式
- **toolbar.css**: 工具栏样式
- **milestones.css**: 里程碑样式

## 开发指导原则

### 代码组织原则
1. **单一职责**: 每个文件和组件只负责一个功能领域
2. **模块化**: 通过清晰的导入导出管理依赖关系
3. **类型安全**: 完整的TypeScript类型定义
4. **性能优化**: 懒加载、记忆化、事件节流等技术

### 架构优势
1. **可维护性**: 清晰的分层和模块化设计
2. **可扩展性**: Hook系统支持功能的灵活组合
3. **可测试性**: 业务逻辑与UI分离，便于单元测试
4. **开发体验**: 完整的类型提示和错误处理

## 📋 最新功能扩展：任务标题右键菜单系统

### 功能概述（2025-07-20 新增）

为任务标题列添加了独立的右键菜单系统，提供任务名称编辑和图标选择功能，与甘特图区域的任务菜单完全分离。

### 架构设计

#### 1. 组件架构
```
TaskTitleItem.tsx (已扩展)
├── 状态管理
│   ├── 编辑状态 (isEditing)
│   ├── 菜单状态 (contextMenu)
│   └── 编辑值 (editValue)
├── 事件处理
│   ├── 右键菜单触发 (handleContextMenu)
│   ├── 内联编辑控制 (handleStartNameEdit, handleConfirmEdit)
│   └── 图标选择 (handleIconChange)
└── UI 渲染
    ├── 内联编辑输入框
    └── TaskTitleContextMenu 组件

TaskTitleContextMenu.tsx (新增)
├── 主菜单
│   ├── 更改任务名称
│   └── 更改任务图标 (悬停展开)
└── 二级菜单
    └── 图标选择器 (5种图标类型)
```

#### 2. 数据流设计
```
用户交互 → TaskTitleItem → handleTaskUpdate → 数据流传递

数据流传递路径：
GanttStateManager.handleTaskUpdate
    ↓
GanttEventCoordinator.handleTaskUpdate
    ↓
GanttContainer.onTaskUpdate
    ↓
GanttChartBody.onTaskUpdate
    ↓
TaskTitleColumn.onTaskUpdate
    ↓
TaskTitleItem.onTaskUpdate
    ↓
setTasks 状态更新
```

#### 3. 核心功能特性

**3.1 任务名称内联编辑**
- 触发：点击"更改任务名称"菜单项
- 编辑模式：原位置输入框替换文本
- 交互：Enter确认、Escape取消、点击外部确认
- 数据更新：通过 `handleTaskUpdate` 直接更新任务 title 字段

**3.2 任务图标选择**
- 触发：悬停"更改任务图标"菜单项
- 显示：二级菜单在主菜单右侧展开
- 选项：default, milestone, development, testing, delivery
- 数据更新：通过 `handleTaskUpdate` 直接更新任务 type 字段

**3.3 菜单系统独立性**
- **任务标题菜单**：专注于任务基本信息编辑（名称+图标）
- **甘特图任务菜单**：专注于任务属性管理（颜色+标签+删除）
- 完全独立的组件和事件处理，无交叉依赖

#### 4. 技术实现要点

**4.1 状态管理**
```typescript
// TaskTitleItem.tsx 中的关键状态
const [isEditing, setIsEditing] = useState(false);
const [editValue, setEditValue] = useState(task.title);
const [contextMenu, setContextMenu] = useState({
  visible: false,
  x: 0,
  y: 0
});
```

**4.2 任务更新函数**
```typescript
// GanttStateManager.tsx 中的核心函数
const handleTaskUpdate = useCallback((taskId: string, updates: Partial<Task>) => {
  setTasks(prevTasks => 
    prevTasks.map(task => 
      task.id === taskId 
        ? { ...task, ...updates }
        : task
    )
  );
}, [setTasks]);
```

**4.3 菜单定位算法**
```typescript
// 右键菜单位置计算
setContextMenu({
  visible: true,
  x: e.clientX,  // 鼠标相对视口的X坐标
  y: e.clientY   // 鼠标相对视口的Y坐标
});

// 二级菜单位置计算
const submenuStyle = {
  left: x + 160,  // 主菜单宽度 + 间距
  top: y
};
```

#### 5. 扩展影响分析

**5.1 新增文件**
- `src/components/gantt/TaskTitleContextMenu.tsx` - 独立右键菜单组件

**5.2 修改文件及影响**
- `TaskTitleItem.tsx` - 集成菜单功能，添加内联编辑
- `TaskTitleColumn.tsx` - 添加 onTaskUpdate props 传递
- `GanttChartBody.tsx` - 传递任务更新函数
- `GanttContainer.tsx` - 数据流传递
- `GanttEventCoordinator.tsx` - 事件协调扩展
- `GanttStateManager.tsx` - 添加任务更新核心逻辑
- `GanttChart.tsx` - 顶层数据流集成

**5.3 架构兼容性**
- ✅ 完全兼容现有架构模式
- ✅ 无破坏性变更
- ✅ 遵循现有的数据流设计
- ✅ 保持组件职责单一原则

#### 6. 性能考虑

**6.1 优化策略**
- 使用 `useCallback` 优化事件处理函数
- 菜单组件按需渲染（visible 控制）
- 内联编辑使用 ref 直接操作 DOM

**6.2 内存管理**
- 正确的事件监听器清理
- 组件卸载时自动清理状态
- 避免内存泄漏的定时器处理

#### 7. 调试和维护

**7.1 调试工具**
- React DevTools 查看状态变化
- 浏览器控制台检查事件绑定
- TypeScript 编译检查类型安全

**7.2 常见问题**
- 菜单定位问题：检查坐标计算
- 编辑状态异常：验证 ref 聚焦
- 数据不更新：确认函数传递链

---

*本文档记录了Gantto甘特图应用的完整代码架构，包括2025-07-20新增的任务标题右键菜单功能的详细技术实现。*