# 里程碑功能需求分析和实施计划

## 项目概述

为Gantto甘特图应用重构里程碑功能，将里程碑节点与任务条分离为两种独立的组件结构，提供更清晰的数据模型和用户交互体验。

## 需求分析

### 1. 核心需求

#### 1.1 数据结构独立化
- **现状问题**：当前里程碑与任务条混用相同数据结构，通过时间相等判断里程碑
- **目标**：设计独立的 TaskBar 和 Milestone 数据类型
- **优势**：概念清晰、类型安全、便于维护

#### 1.2 组件架构分离
- **任务条组件**：专门处理时间段任务，支持完整拖拽功能
- **里程碑组件**：专门处理时间点事件，简化交互逻辑
- **渲染层级**：里程碑永远显示在任务条上方

#### 1.3 交互体验优化
- **选中状态区分**：里程碑保持放大效果，无圆圈边框
- **拖拽逻辑简化**：里程碑仅支持水平移动，无resize操作
- **菜单功能差异**：里程碑和任务条具有不同的右键菜单选项

### 2. 功能特性详述

#### 2.1 里程碑基本特性
- **时间属性**：单一日期（date），代表时间点而非时间段
- **显示位置**：日期的中间位置
- **图标显示**：使用行任务标题图标，大小保持一致
- **层级关系**：永远显示在任务条上方
- **状态管理**：无状态概念，简化数据结构

#### 2.2 附着机制
- **附着条件**：拖拽里程碑到任务条上，且时间有重叠
- **附着效果**：里程碑跟随任务条一起移动
- **解除条件**：拖拽里程碑到任务条时间范围外
- **视觉反馈**：无特殊附着标识，保持简洁

#### 2.3 重叠处理
- **同日重叠**：多个里程碑在同一天时水平错开显示
- **错开方向**：向右错开
- **错开距离**：20px（与图标尺寸相近）
- **数量限制**：不限制同日里程碑数量

#### 2.4 交互操作
- **创建方式**：右键菜单中的"创建里程碑"选项
- **移动操作**：仅支持本行内水平拖拽
- **日期编辑**：双击里程碑图标弹出日历组件
- **拖拽预览**：拖拽时里程碑半透明显示

#### 2.5 右键菜单差异
- **里程碑菜单**：更改标签、更改图标、删除
- **任务条菜单**：更改标签、更改颜色、删除
- **图标选择器**：与任务标题图标选择器保持一致

### 3. 技术约束

#### 3.1 数据兼容性
- **现有数据转换**：自动识别时间相等的任务转为里程碑
- **平滑过渡**：新旧数据结构共存期间的兼容处理
- **数据持久化**：当前不展开SQLite存储开发

#### 3.2 功能范围限制
- **标题编辑**：暂不开发里程碑标题编辑功能
- **批量操作**：暂不支持多选里程碑批量操作
- **视觉提示**：拖拽过程中不显示附着目标提示
- **时间精度**：不支持小时级别的里程碑

## 详细任务清单

### 阶段一：数据结构设计 (1-2天)

#### Task 1.1: 定义新数据类型
- [ ] 设计 BaseTask 基础接口
- [ ] 定义 TaskBar 任务条接口
- [ ] 定义 Milestone 里程碑接口
- [ ] 创建 ChartItem 联合类型
- [ ] 更新相关类型导入导出

**文件涉及：**
- `src/types/task.ts`
- `src/types/milestone.ts`
- `src/types/index.ts`

#### Task 1.2: 数据转换工具
- [ ] 实现 convertLegacyData 转换函数
- [ ] 添加数据类型检测工具
- [ ] 创建数据验证函数
- [ ] 编写转换单元测试

**文件涉及：**
- `src/utils/dataConverter.ts`
- `src/utils/typeGuards.ts`

### 阶段二：里程碑组件开发 (3-4天)

#### Task 2.1: MilestoneRenderer 组件
- [ ] 创建里程碑渲染组件基础结构
- [ ] 实现里程碑图标显示逻辑
- [ ] 添加选中状态处理（放大效果）
- [ ] 实现重叠错开显示算法
- [ ] 添加基础样式定义

**文件涉及：**
- `src/components/gantt/MilestoneRenderer.tsx`
- `src/styles/milestones.css`

#### Task 2.2: 里程碑拖拽系统
- [ ] 创建 useMilestoneDrag Hook
- [ ] 实现水平拖拽逻辑
- [ ] 添加拖拽预览效果（半透明）
- [ ] 限制拖拽范围（仅本行内）
- [ ] 集成到 MilestoneRenderer

**文件涉及：**
- `src/hooks/gantt/useMilestoneDrag.ts`
- `src/hooks/gantt/useMilestoneEvents.ts`

#### Task 2.3: 里程碑数据管理
- [ ] 创建 useMilestoneManager Hook
- [ ] 实现里程碑CRUD操作
- [ ] 添加位置计算逻辑
- [ ] 实现重叠检测和错开算法

**文件涉及：**
- `src/hooks/gantt/useMilestoneManager.ts`
- `src/utils/milestoneUtils.ts`

### 阶段三：附着机制实现 (2-3天)

#### Task 3.1: 附着检测逻辑
- [ ] 实现时间重叠检测算法
- [ ] 创建附着状态管理
- [ ] 添加附着/解除触发逻辑
- [ ] 实现任务条关联移动

**文件涉及：**
- `src/hooks/gantt/useMilestoneAttachment.ts`
- `src/utils/attachmentUtils.ts`

#### Task 3.2: 拖拽附着集成
- [ ] 集成附着检测到拖拽系统
- [ ] 实现拖拽结束时的附着处理
- [ ] 添加解除附着的拖拽逻辑
- [ ] 优化拖拽性能

**文件涉及：**
- `src/hooks/gantt/useMilestoneDrag.ts`（更新）
- `src/hooks/gantt/useTaskBarDrag.ts`（更新）

### 阶段四：交互功能完善 (2-3天)

#### Task 4.1: 右键菜单系统
- [ ] 创建 MilestoneContextMenu 组件
- [ ] 实现更改标签功能
- [ ] 实现更改图标功能（复用现有选择器）
- [ ] 实现删除功能
- [ ] 集成到里程碑组件

**文件涉及：**
- `src/components/gantt/MilestoneContextMenu.tsx`
- `src/hooks/gantt/useMilestoneContextMenu.ts`

#### Task 4.2: 日历编辑功能
- [ ] 创建里程碑日期编辑器
- [ ] 实现双击触发逻辑
- [ ] 集成日历组件
- [ ] 实现自动确认机制
- [ ] 添加日期范围限制

**文件涉及：**
- `src/components/gantt/MilestoneDateEditor.tsx`
- `src/hooks/gantt/useMilestoneDateEdit.ts`

#### Task 4.3: 创建功能
- [ ] 在甘特图右键菜单添加"创建里程碑"选项
- [ ] 实现里程碑创建逻辑
- [ ] 设置默认属性（图标、颜色等）
- [ ] 集成到现有创建流程

**文件涉及：**
- `src/components/gantt/GanttContextMenu.tsx`（更新）
- `src/hooks/gantt/useMilestoneCreation.ts`

### 阶段五：组件集成和渲染优化 (2-3天)

#### Task 5.1: TaskBars 组件重构
- [ ] 分离任务条渲染逻辑到 TaskBarRenderer
- [ ] 集成 MilestoneRenderer
- [ ] 实现混合渲染逻辑
- [ ] 优化渲染性能

**文件涉及：**
- `src/components/gantt/TaskBars.tsx`（重构）
- `src/components/gantt/TaskBarRenderer.tsx`（新建）

#### Task 5.2: 数据流集成
- [ ] 更新 GanttStateManager 支持里程碑
- [ ] 修改数据提供者逻辑
- [ ] 集成到现有状态管理
- [ ] 优化数据更新性能

**文件涉及：**
- `src/components/gantt/GanttStateManager.tsx`（更新）
- `src/hooks/gantt/useGanttState.ts`（更新）

#### Task 5.3: 事件协调
- [ ] 更新事件协调器支持里程碑
- [ ] 统一事件处理逻辑
- [ ] 优化事件冒泡和委托
- [ ] 确保事件不冲突

**文件涉及：**
- `src/components/gantt/GanttEventCoordinator.tsx`（更新）
- `src/hooks/gantt/useGanttEvents.ts`（更新）

### 阶段六：数据兼容性和迁移 (1-2天)

#### Task 6.1: 数据迁移实现
- [ ] 实现启动时自动检测和转换
- [ ] 添加数据转换错误处理
- [ ] 实现数据备份机制
- [ ] 添加转换日志记录

**文件涉及：**
- `src/utils/dataMigration.ts`
- `src/hooks/useDataMigration.ts`

#### Task 6.2: 兼容性测试
- [ ] 创建测试数据集
- [ ] 测试各种数据转换场景
- [ ] 验证现有功能不受影响
- [ ] 测试性能影响

**文件涉及：**
- `src/tests/dataMigration.test.ts`
- `src/tests/compatibility.test.ts`

### 阶段七：样式和体验优化 (1-2天)

#### Task 7.1: 样式完善
- [ ] 完善里程碑样式定义
- [ ] 优化拖拽预览样式
- [ ] 调整重叠错开视觉效果
- [ ] 确保响应式兼容性

**文件涉及：**
- `src/styles/milestones.css`（完善）
- `src/styles/gantt.css`（更新）

#### Task 7.2: 交互优化
- [ ] 优化拖拽手感
- [ ] 改善选中反馈
- [ ] 调整错开距离
- [ ] 测试各种交互场景

### 阶段八：测试和文档 (1-2天)

#### Task 8.1: 功能测试
- [ ] 里程碑基础功能测试
- [ ] 拖拽功能测试
- [ ] 附着机制测试
- [ ] 右键菜单测试
- [ ] 数据转换测试

#### Task 8.2: 集成测试
- [ ] 与现有任务条功能集成测试
- [ ] 性能测试
- [ ] 浏览器兼容性测试
- [ ] 用户体验测试

#### Task 8.3: 文档更新
- [ ] 更新架构分析文档
- [ ] 更新 CLAUDE.md
- [ ] 添加里程碑功能说明
- [ ] 更新组件文档

**文件涉及：**
- `架构分析文档.md`（更新）
- `CLAUDE.md`（更新）
- `里程碑功能说明.md`（新建）

## 技术实施细节

### 数据结构设计

```typescript
// 基础任务接口
interface BaseTask {
  id: string;
  title: string;
  color: string;
  tags?: string[];
  order: number;
  rowId?: string;
}

// 任务条（时间段）
interface TaskBar extends BaseTask {
  taskType: 'task';
  startDate: Date;
  endDate: Date;
  type: 'development' | 'testing' | 'delivery' | 'default';
  status: 'pending' | 'in-progress' | 'completed' | 'overdue';
  progress?: number;
  // 计算属性
  x: number;
  width: number;
  // 关联的里程碑
  attachedMilestones?: string[];
}

// 里程碑节点（时间点）
interface Milestone extends BaseTask {
  taskType: 'milestone';
  date: Date;  // 单一日期
  type: 'milestone' | 'deadline' | 'checkpoint' | 'release';
  // 计算属性
  x: number;  // 位置
  // 附着关系
  attachedToTask?: string;
}

// 联合类型
type ChartItem = TaskBar | Milestone;
```

### 组件架构

```
TaskBars.tsx (重构)
├── TaskBarRenderer.tsx (新建)
│   ├── 任务条专用拖拽
│   ├── 进度条显示
│   ├── 圆圈边框选中
│   └── 任务条右键菜单
└── MilestoneRenderer.tsx (新建)
    ├── 里程碑专用拖拽
    ├── 图标显示
    ├── 放大选中效果
    ├── 重叠错开算法
    ├── 附着检测
    ├── 里程碑右键菜单
    └── 日期编辑功能
```

### Hook架构

```
里程碑相关Hooks:
├── useMilestoneManager.ts     // 里程碑数据管理
├── useMilestoneDrag.ts        // 里程碑拖拽逻辑
├── useMilestoneAttachment.ts  // 附着机制
├── useMilestoneContextMenu.ts // 右键菜单
├── useMilestoneDateEdit.ts    // 日期编辑
└── useMilestoneCreation.ts    // 创建功能
```

## 预期成果

### 1. 功能成果
- **独立组件架构**：里程碑和任务条完全分离
- **流畅交互体验**：拖拽、选中、编辑等操作直观自然
- **智能附着机制**：里程碑可与任务条建立关联关系
- **数据兼容性**：现有数据无缝迁移到新架构

### 2. 技术成果
- **类型安全**：完整的TypeScript类型定义
- **性能优化**：组件渲染和事件处理优化
- **代码质量**：遵循CLAUDE.md规范，单文件<300行
- **可维护性**：清晰的模块分离和职责划分

### 3. 用户体验
- **概念清晰**：里程碑和任务条功能明确区分
- **操作简单**：拖拽、编辑等操作符合直觉
- **视觉优化**：选中状态、重叠处理等视觉反馈良好
- **功能完整**：创建、编辑、删除等基础功能完备

## 风险评估

### 技术风险
- **数据迁移复杂性**：现有数据转换可能遇到边界情况
- **性能影响**：新增里程碑渲染可能影响大量数据时的性能
- **事件冲突**：里程碑和任务条事件处理可能产生冲突

### 解决方案
- **渐进式迁移**：分步骤验证数据转换的正确性
- **性能监控**：添加性能测试，确保不影响现有体验
- **事件隔离**：明确事件处理边界，避免事件冒泡冲突

## 项目时间线

**总预期时间：12-18天**

- 阶段一：数据结构设计 (1-2天)
- 阶段二：里程碑组件开发 (3-4天)
- 阶段三：附着机制实现 (2-3天)
- 阶段四：交互功能完善 (2-3天)
- 阶段五：组件集成和渲染优化 (2-3天)
- 阶段六：数据兼容性和迁移 (1-2天)
- 阶段七：样式和体验优化 (1-2天)
- 阶段八：测试和文档 (1-2天)

## 验收标准

### 功能验收
- [ ] 里程碑可以独立创建、拖拽、编辑、删除
- [ ] 里程碑附着机制工作正常
- [ ] 重叠里程碑正确错开显示
- [ ] 右键菜单功能完整
- [ ] 日期编辑功能正常
- [ ] 现有数据正确迁移

### 技术验收
- [ ] 代码符合CLAUDE.md规范
- [ ] TypeScript类型检查通过
- [ ] 性能不低于现有水平
- [ ] 单元测试覆盖核心功能
- [ ] 文档完整更新

### 用户体验验收
- [ ] 交互操作流畅自然
- [ ] 视觉反馈清晰准确
- [ ] 学习成本低
- [ ] 错误处理友好

---

*本文档版本：v1.0*  
*创建日期：2025-07-20*  
*最后更新：2025-07-20*