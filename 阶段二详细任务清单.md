# 阶段二详细任务清单：状态管理抽离

> **创建日期**: 2025-07-13  
> **优先级**: 🔴 高  
> **预估工期**: 5-7天  
> **风险等级**: 中等

## 🎯 阶段目标

将 `GanttChart.tsx` 中的复杂状态管理逻辑抽离到独立的自定义 Hooks 中，提升代码的可维护性和可测试性。

## 📋 任务分解

### 1. 基础设施建设 (Day 1)

#### 1.1 创建 Hooks 目录结构
- [ ] 创建 `src/hooks/` 目录
- [ ] 创建子目录结构：
  - `src/hooks/gantt/` - Gantt相关hooks
  - `src/hooks/common/` - 通用hooks
- [ ] 创建统一导出文件 `src/hooks/index.ts`

#### 1.2 分析现有状态逻辑
- [ ] 分析 `GanttChart.tsx` 中的状态使用情况
- [ ] 识别可抽离的状态逻辑模块：
  - 拖拽状态管理
  - 任务CRUD操作
  - 时间轴计算
  - UI状态管理

### 2. 拖拽逻辑抽离 (Day 2-3)

#### 2.1 创建 `useDragAndDrop` Hook
- [ ] 抽离水平拖拽逻辑 (任务时间线调整)
- [ ] 抽离垂直拖拽逻辑 (任务重排序)
- [ ] 实现拖拽状态管理：
  ```typescript
  interface DragState {
    isDragging: boolean;
    dragType: 'horizontal' | 'vertical' | null;
    dragTaskId: string | null;
    startX: number;
    startY: number;
    // ... 其他状态
  }
  ```

#### 2.2 性能优化逻辑抽离
- [ ] 抽离 `useDragCache` 相关逻辑
- [ ] 抽离 `useThrottledMouseMove` 相关逻辑
- [ ] 保持现有性能优化特性

#### 2.3 测试拖拽功能
- [ ] 验证水平拖拽功能正常
- [ ] 验证垂直拖拽功能正常
- [ ] 验证拖拽性能未降低

### 3. 任务管理逻辑抽离 (Day 3-4)

#### 3.1 创建 `useTaskManager` Hook
- [ ] 抽离任务CRUD操作：
  - 添加任务 (`addTask`)
  - 删除任务 (`deleteTask`)
  - 更新任务 (`updateTask`)
  - 复制任务 (`duplicateTask`)
- [ ] 抽离层级管理逻辑：
  - 展开/折叠 (`toggleExpand`)
  - 层级计算 (`calculateLevel`)
  - 父子关系管理

#### 3.2 任务状态计算
- [ ] 抽离可见任务计算 (`getVisibleTasks`)
- [ ] 抽离父任务进度计算 (`calculateParentProgress`)
- [ ] 抽离任务排序逻辑

#### 3.3 数据持久化
- [ ] 保持现有的数据变更通知机制
- [ ] 确保状态同步正确性

### 4. 时间轴计算逻辑抽离 (Day 4-5)

#### 4.1 创建 `useTimeline` Hook
- [ ] 抽离时间轴缩放逻辑：
  ```typescript
  interface TimelineState {
    scale: number;
    startDate: Date;
    endDate: Date;
    pixelsPerDay: number;
    // ... 其他状态
  }
  ```

#### 4.2 日期计算函数
- [ ] 抽离日期到像素转换 (`dateToPixels`)
- [ ] 抽离像素到日期转换 (`pixelsToDate`)
- [ ] 抽离时间范围计算逻辑

#### 4.3 视口管理
- [ ] 抽离滚动状态管理
- [ ] 抽离可视区域计算
- [ ] 抽离时间刻度显示逻辑

### 5. UI状态管理抽离 (Day 5-6)

#### 5.1 创建 `useGanttUI` Hook
- [ ] 抽离选择状态管理
- [ ] 抽离悬停状态管理
- [ ] 抽离编辑模式状态

#### 5.2 交互状态
- [ ] 抽离右键菜单状态
- [ ] 抽离工具提示状态
- [ ] 抽离键盘快捷键处理

### 6. 重构主组件 (Day 6-7)

#### 6.1 简化 `GanttChart.tsx`
- [ ] 移除已抽离的状态逻辑
- [ ] 使用新创建的自定义 Hooks
- [ ] 保持组件API不变

#### 6.2 类型安全检查
- [ ] 确保所有类型定义正确
- [ ] 使用 `src/types` 中的统一类型
- [ ] 通过 TypeScript 编译检查

#### 6.3 功能验证
- [ ] 所有现有功能正常工作
- [ ] 性能无明显降低
- [ ] 用户体验保持一致

## 🔍 验收标准

### 功能性验收
- [ ] 所有拖拽功能正常（水平、垂直）
- [ ] 任务CRUD操作正常
- [ ] 层级展开/折叠功能正常
- [ ] 时间轴缩放功能正常
- [ ] 选择和编辑功能正常

### 代码质量验收
- [ ] TypeScript 编译无错误
- [ ] 代码可读性提升
- [ ] 职责分离清晰
- [ ] 自定义 Hooks 可复用

### 性能验收
- [ ] 拖拽操作流畅度保持
- [ ] 大数据量渲染性能无降低
- [ ] 内存使用无明显增加

## 📁 文件结构预期

```
src/hooks/
├── index.ts                 # 统一导出
├── gantt/
│   ├── useDragAndDrop.ts   # 拖拽逻辑
│   ├── useTaskManager.ts   # 任务管理
│   ├── useTimeline.ts      # 时间轴计算
│   └── useGanttUI.ts       # UI状态管理
└── common/
    ├── useThrottle.ts      # 通用节流hook
    └── useCache.ts         # 通用缓存hook
```

## ⚠️ 风险控制

### 主要风险点
1. **状态同步**: 多个Hook间的状态可能不同步
2. **性能回退**: 状态抽离可能影响性能优化
3. **类型复杂度**: Hook间的类型传递可能变复杂

### 缓解策略
1. 分步进行，每个Hook独立验证
2. 保持现有性能优化机制
3. 充分利用TypeScript类型检查
4. 随时可回滚到上一个稳定版本

## 📊 进度跟踪

- **开始日期**: 2025-07-13
- **当前状态**: 📝 准备中
- **完成度**: 0%

---

**下一步动作**: 创建 Hooks 目录结构并开始状态逻辑分析